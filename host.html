<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta-X WebRTC Host</title>
    <style>
        /* CSS للحصول على واجهة احترافية */
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', monospace; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
        }
        h1 { font-size: 24px; text-shadow: 0 0 10px #0f0; }
        #status { color: #888; margin-bottom: 20px; }
        video { 
            width: 90%; 
            max-width: 500px; 
            border: 2px solid #333; 
            border-radius: 10px; 
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); 
            background: #111;
        }
        button { 
            padding: 15px 40px; 
            font-size: 18px; 
            font-weight: bold;
            cursor: pointer; 
            background: #0f0; 
            color: #000; 
            border: none; 
            border-radius: 50px; 
            transition: 0.3s;
            box-shadow: 0 0 15px #0f0;
        }
        button:hover { transform: scale(1.05); box-shadow: 0 0 25px #0f0; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <h1>DELTA-X STREAMER</h1>
    <div id="status">جاهز للبدء..</div>
    
    <button id="startBtn">ابدأ بث الشاشة الآن</button>
    
    <video id="localVideo" autoplay playsinline muted></video>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // 1. إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyCpeOSPCzow5Iv472BUEmKvYVt63cIsi-E",
            authDomain: "delta-x-b7b69.firebaseapp.com",
            databaseURL: "https://delta-x-b7b69-default-rtdb.firebaseio.com",
            projectId: "delta-x-b7b69",
            storageBucket: "delta-x-b7b69.firebasestorage.app",
            messagingSenderId: "758371825673",
            appId: "1:758371825673:web:59fcf8401f5ae58bf9a0d8"
        };

        // 2. تهيئة التطبيق
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const startBtn = document.getElementById('startBtn');
        const localVideo = document.getElementById('localVideo');
        const statusDiv = document.getElementById('status');

        let peerConnection;
        const servers = {
            iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }]
        };

        // 3. وظيفة بدء البث
        startBtn.onclick = async () => {
            try {
                statusDiv.innerText = "جاري طلب إذن الشاشة...";
                
                // التقاط شاشة الموبايل (WebRTC API)
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: "always" }, 
                    audio: false 
                });
                
                localVideo.srcObject = stream;
                startBtn.style.display = 'none'; // إخفاء الزرار بعد البدء
                statusDiv.innerText = "تم التقاط الشاشة. جاري الربط...";

                // إنشاء الـ Peer Connection
                peerConnection = new RTCPeerConnection(servers);
                
                // إضافة مسارات الفيديو للاتصال
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                // التعامل مع ICE Candidates (ضروري لربط الأجهزة ببعضها)
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        db.ref('rooms/1/hostCandidates').push(event.candidate.toJSON());
                    }
                };

                // إنشاء الـ Offer ورفعه للفايربيس
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await db.ref('rooms/1').set({
                    offer: { type: offer.type, sdp: offer.sdp }
                });

                statusDiv.innerText = "البث مباشر الآن! في انتظار الطرف الآخر...";

                // الاستماع للرد (Answer) من الطرف الآخر (الكمبيوتر)
                db.ref('rooms/1/answer').on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        const remoteDesc = new RTCIceDescription(answer);
                        await peerConnection.setRemoteDescription(remoteDesc);
                        statusDiv.innerText = "تم الاتصال بالطرف الآخر بنجاح! ✅";
                        statusDiv.style.color = "#0f0";
                    }
                });

                // الاستماع للـ Candidates من الطرف الآخر
                db.ref('rooms/1/remoteCandidates').on('child_added', (snapshot) => {
                    const candidate = new RTCIceCandidate(snapshot.val());
                    peerConnection.addIceCandidate(candidate);
                });

            } catch (err) {
                console.error(err);
                statusDiv.innerText = "خطأ: " + err.message;
                statusDiv.style.color = "red";
            }
        };
    </script>
</body>
</html>
